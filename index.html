<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>GIS + 3D PLY Viewer PRO</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
    
    <style>
        body { margin: 0; padding: 0; overflow: hidden; font-family: sans-serif; }
        #map { width: 100vw; height: 100vh; }
        
        /* Модальное окно */
        #modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.65);
            backdrop-filter: blur(4px);
            z-index: 99999 !important;
            justify-content: center;
            align-items: center;
        }

        #box {
            width: 80%;
            height: 80%;
            background: #fff;
            border-radius: 15px;
            box-shadow: 0 0 20px #0005;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        #topbar {
            height: 45px;
            background: #222;
            color: white;
            display: flex;
            align-items: center;
            padding: 0 15px;
            gap: 10px;
            justify-content: space-between;
        }

        #viewer {
            flex-grow: 1;
            width: 100%;
            height: 100%;
            position: relative;
        }

        #btnClose {
            background: #444;
            border: none;
            color: white;
            padding: 5px 15px;
            border-radius: 4px;
            cursor: pointer;
        }
        #btnClose:hover { background: #666; }
    </style>

    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>

    <div id="modal">
        <div id="box">
            <div id="topbar">
                <span id="modelTitle">3D Просмотр</span>
                <button id="btnClose">Закрыть</button>
            </div>
            <div id="viewer"></div>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { PLYLoader } from 'three/addons/loaders/PLYLoader.js';

    // ----- Инициализация карты (Leaflet) -----
    const map = L.map('map').setView([43.250, 76.945], 13);
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

    // UI элементы
    const modal = document.getElementById("modal");
    const btnClose = document.getElementById("btnClose");
    const viewer = document.getElementById("viewer");
    const modelTitle = document.getElementById("modelTitle");
    
    // Вспомогательная функция для инвертирования координат (Leaflet ожидает [Lat, Lng])
    function invertCoords(coords) {
        // Координаты в CSV были: X (Долгота/Lng), Y (Широта/Lat)
        // Leaflet Polygon ожидает: [[Lat, Lng], [Lat, Lng], ...]
        return coords.map(([lng, lat]) => [lat, lng]);
    }

    // ----- СПИСОК ОБЪЕКТОВ (ТОЧНЫЕ ПОЛИГОНЫ ИЗ CSV) -----
    const monuments = [
        {
            name: "Главный корпус Академии наук Республики Казахстан, ныне –здание Республиканского государственного предприятия Ғылым ордасы",
            polygon: invertCoords([
                [76.9521638934013, 43.24633284493293], [76.952386248696087, 43.246349083157263], [76.952402820702133, 43.24623801868011], [76.95291142801301, 43.24627011852504], [76.952871433487587, 43.246586929757413], [76.953228116015083, 43.246615464299538], [76.953264782451782, 43.246293973724171], [76.953770064711961, 43.246322110533761], [76.953760759501264, 43.246434163423423], [76.9539813913277, 43.246449048963591], [76.954037063724783, 43.245970772567937], [76.95396036080561, 43.245966741592277], [76.953967467716225, 43.245893929435468], [76.954036906730778, 43.2458979622128], [76.954111871611815, 43.245343450516678], [76.953904173084453, 43.245333602052817], [76.953894965091692, 43.245388864635927], [76.9533871010766, 43.245351908951747], [76.953365378643184, 43.245503385060843], [76.95387336510332, 43.24553620078747], [76.953793904980813, 43.246226074144808], [76.953229647599755, 43.246190661663817], [76.953299675208839, 43.245591241474557], [76.95333364170159, 43.2452908115906], [76.953107351079765, 43.245276196160347], [76.953099491206572, 43.24531939828919], [76.953040394230385, 43.245314732457928], [76.953040397058984, 43.245321032492029], [76.953013807634491, 43.245328328908862], [76.952992084284318, 43.245479804947948], [76.953025817818443, 43.245480066864921], [76.953015863255729, 43.245519579468557], [76.9530608017078, 43.245523078706412], [76.952975403344936, 43.24616939268909], [76.952409177064183, 43.246133886630879], [76.952504902711, 43.245441490384273], [76.9529808808112, 43.245479717630268], [76.953005433074665, 43.24532212088166], [76.9525230542057, 43.24528380524319], [76.952528581181568, 43.245253923776723], [76.952318048005566, 43.245235883054548], [76.952244531691463, 43.245761323090669], [76.9523218506035, 43.245767155083009], [76.952306008224724, 43.245857519274772], [76.952231889455035, 43.245849976517363], [76.9521638934013, 43.24633284493293]
            ])
        },
        {
            name: "Государственная библиотека имени А.С. Пушкина, ныне – здание Национальной библиотеки Республики Казахстан",
            polygon: invertCoords([
                [76.944086559684436, 43.241731809377832], [76.944135544782071, 43.24128782870153], [76.94222514861741, 43.241163291597], [76.942164453837151, 43.241604483144883], [76.944086559684436, 43.241731809377832]
            ])
        },
        {
            name: "Верненская мужская гимназия, ныне – здание Казахского национального педагогического университета имени Абая",
            polygon: invertCoords([
                [76.953258873697479, 43.256904032215289], [76.953652927317634, 43.256932466332962], [76.953654161505284, 43.256938586051682], [76.953781982581035, 43.256947464655617], [76.953777072886851, 43.256981755985677], [76.953956612421464, 43.256991611643492], [76.953960291849626, 43.256959930620027], [76.954074813293758, 43.256967012187737], [76.954076040182812, 43.256957381848459], [76.954486965641962, 43.256988418899141], [76.9545148213175, 43.256784291141031], [76.954288240941779, 43.256768328147523], [76.954280993582259, 43.256806130099037], [76.95409418863386, 43.256794566754508], [76.9540954134594, 43.256780526399673], [76.953673655122685, 43.25675300061323], [76.953671197214078, 43.256763531253881], [76.953280717655574, 43.2567395063489], [76.953258873697479, 43.256904032215289]
            ])
        },
        {
            name: "Дворец Республики",
            polygon: invertCoords([
                [76.95882384397288, 43.243560168667969], [76.9591184598962, 43.243581682829848], [76.959123987887708, 43.243559811082442], [76.959178898011189, 43.243564745002857], [76.959175708254662, 43.243584996057081], [76.959179773482944, 43.2435896748908], [76.959245148059239, 43.243594605706477], [76.959249699345179, 43.243587674327237], [76.959255100462769, 43.243559052571563], [76.960019157723124, 43.243615345512843], [76.960026637325214, 43.243561792950423], [76.960077729514936, 43.24356393757229], [76.96008582100751, 43.243503994783829], [76.960033374194111, 43.243501040568653], [76.9600894019019, 43.243086571256811], [76.960099004010431, 43.243085758356038], [76.9601137016203, 43.242951923130683], [76.959341528088416, 43.2428969832166], [76.959348773953977, 43.242865120889618], [76.959336089317361, 43.2428572045849], [76.959280687181078, 43.242851910882031], [76.959267026753068, 43.242860464954823], [76.959264329351228, 43.242880445867442], [76.95920621879344, 43.242875152925713], [76.959210761765576, 43.242853191460327], [76.958919228329236, 43.242834016649162], [76.958908318290611, 43.242919700335683], [76.958887595572321, 43.243071717268208], [76.958843211918278, 43.243406532144128], [76.958786948237588, 43.243402498460419], [76.958778364752234, 43.243465591319257], [76.958834629028729, 43.243470615012718], [76.95882384397288, 43.243560168667969]
            ])
        },
        {
            name: "Дом Правительства Казахской ССР, ныне – здание Казахской национальной академии искусств имени Т. Жургенова",
            polygon: invertCoords([
                [76.9439577070182, 43.252112394665232], [76.943994805429483, 43.25182591744877], [76.9445893997442, 43.251864160428973], [76.944568391824987, 43.252015184577772], [76.944371260867953, 43.252004417058643], [76.944356758063932, 43.252090009812058], [76.944325729070641, 43.252087584886617], [76.944316018338, 43.252141046709163], [76.9443600996528, 43.252145809506949], [76.94435518367429, 43.252175600442818], [76.9446712599652, 43.252195888256189], [76.944722872984457, 43.251873768229842], [76.945110610785932, 43.251902502861739], [76.945147704788425, 43.251619535277612], [76.94498800447171, 43.251605162400338], [76.944971907622943, 43.251708575586747], [76.9450061377567, 43.2517109997939], [76.9449996275032, 43.2517597811141], [76.944765064708918, 43.251742990590323], [76.944769982711961, 43.251720399666127], [76.944737353264316, 43.251718065120848], [76.9447551694375, 43.251599171610842], [76.944569489115921, 43.251583632492718], [76.944550072658316, 43.2517048662497], [76.944387171699745, 43.251692923074827], [76.944382252450708, 43.25171191396695], [76.943983313443582, 43.251689208692788], [76.944008968217688, 43.251427663401458], [76.943841266514909, 43.251416890226423], [76.943813881210843, 43.251658185666571], [76.943838261102115, 43.251660611791671], [76.943776951877979, 43.252101623491981], [76.9439577070182, 43.252112394665232]
            ])
        },
        {
            name: "Литературно-мемориальный дом-музей М.О. Ауэзова",
            polygon: invertCoords([
                [76.9496636419387, 43.243508372539239], [76.949671742183043, 43.243444740462792], [76.949660046078449, 43.243443212915018], [76.949664098308673, 43.24341675190761], [76.949675671475063, 43.243418729483523], [76.949683774461221, 43.243362117445812], [76.949478050258065, 43.243344880481779], [76.949466502134456, 43.243406983256207], [76.949523503799057, 43.2434108413693], [76.9495113497685, 43.243497514417832], [76.9496636419387, 43.243508372539239]
            ])
        },
        {
            name: "Дом зодчих Зенковых, ныне – здание Станции скорой медицинской помощи",
            polygon: invertCoords([
                [76.930606985365714, 43.255722593310942], [76.930463039608327, 43.25571512949832], [76.930445200893, 43.255915471002623], [76.93058853136813, 43.2559220348609], [76.930606985365714, 43.255722593310942]
            ])
        },
        {
            name: "Дом Правительства Казахской ССР, ныне – здание Казахстанско-британского технического университета",
            polygon: invertCoords([
                [76.943558531248229, 43.255900213310319], [76.943507289768661, 43.256262112674392], [76.943708868287914, 43.256276480982791], [76.94383911550895, 43.255347476829911], [76.943622517136419, 43.255331491110582], [76.943629029851465, 43.255286039911077], [76.943470306331179, 43.255274904782688], [76.943455443240779, 43.255398657574588], [76.94365689576459, 43.255413025996532], [76.9436078828021, 43.25581254522416], [76.94328193672105, 43.255790186004731], [76.943296929285424, 43.255686773299772], [76.943329058487677, 43.255655448205857], [76.943352691806425, 43.255625744428109], [76.943356874292391, 43.2556116137257], [76.943359085255267, 43.255592803311792], [76.9433590788712, 43.255570843230267], [76.943356856973821, 43.255552033504557], [76.943348354752956, 43.25553169474793], [76.94332470373736, 43.25550028829786], [76.943294651562411, 43.255475182857211], [76.943305338413069, 43.255385900865292], [76.943449038845884, 43.255393888556327], [76.9434618095847, 43.255273286104], [76.942908678577282, 43.255233321011367], [76.942891597962969, 43.2553571640669], [76.943084553467841, 43.255369914775443], [76.943071772105483, 43.255456047055148], [76.943043949022424, 43.255474861373813], [76.943018220086827, 43.255496735378273], [76.942992494258974, 43.255529589417741], [76.942981789563561, 43.25555785115175], [76.942977488749534, 43.255589171923127], [76.942983899787123, 43.255617341054432], [76.943001145850914, 43.255642448525542], [76.943016174161343, 43.2556628763142], [76.942996872260835, 43.255769349649867], [76.942675359505429, 43.255746988027127], [76.942728687338374, 43.255344318536061], [76.94288310122036, 43.255355545345239], [76.9428979654595, 43.255231792626581], [76.942773721126983, 43.2552253313285], [76.942767207326924, 43.25526916247378], [76.94255713695604, 43.25525794377468], [76.94243979889373, 43.256183884571662], [76.942639160878841, 43.256199785097493], [76.942684003092168, 43.255833207057023], [76.943003300761788, 43.255858719003939], [76.942977748731, 43.256070223670562], [76.943213559214939, 43.256087737656728], [76.943243420208773, 43.255876322273707], [76.943558531248229, 43.255900213310319]
            ])
        },
        {
            name: "Дом почетного гражданина города Верный Т.А. Головизина, ныне – здание Государственной резиденции № 4",
            polygon: invertCoords([
                [76.948518468198586, 43.244498343454929], [76.948432533366827, 43.2444925106106], [76.948436086786288, 43.244447419645347], [76.948292657265611, 43.2444383581434], [76.948276578676158, 43.244570842083377], [76.9485077906238, 43.24458699609594], [76.948518468198586, 43.244498343454929]
            ])
        },
        {
            name: "Дом купца М.А. Гаврилова",
            polygon: invertCoords([
                [76.9409721066115, 43.242844947158751], [76.940776235590789, 43.2428286832228], [76.940738002652438, 43.2430469395876], [76.9409337508687, 43.2430616735958], [76.9409721066115, 43.242844947158751]
            ])
        },
        {
            name: "Торговый дом купца И. Габдувалиева, ныне – Дом тканей Қызыл-Таң",
            polygon: invertCoords([
                [76.9507768147081, 43.262646442952587], [76.9507908167495, 43.262556799641651], [76.950751395522886, 43.262523958234993], [76.950114204027827, 43.262477746484073], [76.950071208722818, 43.262744336368783], [76.95028327885619, 43.262761120833339], [76.950307233839965, 43.262614865291368], [76.9507768147081, 43.262646442952587]
            ])
        },
        {
            name: "Дом офицерского собрания, ныне–здание Музея народных музыкальных инструментов имени Ыкыласа",
            polygon: invertCoords([
                [76.95671525444061, 43.259620972962438], [76.9568721444148, 43.259631910202039], [76.956870304362553, 43.259645770747348], [76.956968206706364, 43.259652583956523], [76.9569841601579, 43.2595452092522], [76.957006942673743, 43.2595472730041], [76.9570351521819, 43.259326944575641], [76.957007567234612, 43.259324972148541], [76.9570198283916, 43.259221738460042], [76.956920941224809, 43.259214205562], [76.956917137655182, 43.259241206687669], [76.956761233493751, 43.25922963923842], [76.95674908581627, 43.259314782812183], [76.956779503074586, 43.259316844529707], [76.956770057150777, 43.259387497323061], [76.956756758110316, 43.259388220949262], [76.9567473107266, 43.259456083731678], [76.956760610516483, 43.25945680011084], [76.956750305715445, 43.2595336631539], [76.956727523213317, 43.259531599350879], [76.95671525444061, 43.259620972962438]
            ])
        },
        {
            name: "Дом купца Г. Шахворостова, ныне – здание консульства Соединенных Штатов Америки в Республике Казахстан",
            polygon: invertCoords([
                [76.946025490720473, 43.258656868829227], [76.946055215604474, 43.258432042787057], [76.945846117511209, 43.258416689948007], [76.945837525182981, 43.258499761739543], [76.945885674315434, 43.258502903218648], [76.945867743704639, 43.258647446865943], [76.946025490720473, 43.258656868829227]
            ])
        },
        {
            name: "Спортивный комплекс Медеу",
            polygon: invertCoords([
                [77.059248736884143, 43.1564842073164], [77.0592706206604, 43.156541152924547], [77.059149737702668, 43.1565806249145], [77.058978423142776, 43.156663896485917], [77.057938603474142, 43.15762029366509], [77.057998439069365, 43.157660905264258], [77.057919194474835, 43.157741278587579], [77.05786911358787, 43.157834398401093], [77.0578343172818, 43.157946220906972], [77.0578480953947, 43.1580643773889], [77.057879492101677, 43.158143272697536], [77.057929568619855, 43.15821890632504], [77.058021318301243, 43.158179109353178], [77.058058774356525, 43.158217316769658], [77.0581054555542, 43.158257673532923], [77.058216489258243, 43.158323516216143], [77.058123769402684, 43.158426405748983], [77.05824497333694, 43.158476486301169], [77.058344371762075, 43.1585056216027], [77.058427263814565, 43.158519745678817], [77.058611354712184, 43.158542752261553], [77.058684918115489, 43.1585636371335], [77.058724291242058, 43.15857853162656], [77.05880207065475, 43.1586159718527], [77.05880207065475, 43.1586159718527], [77.0588550382253, 43.158663521133462], [77.059006555845144, 43.158575952774193], [77.058945360285492, 43.158532553237592], [77.058863002395526, 43.158481438164067], [77.058814748716046, 43.15845323378938], [77.058743886158865, 43.158430545820693], [77.05867807354349, 43.158412172021492], [77.058628391402507, 43.158405479666371], [77.058630234821578, 43.158348506365449], [77.058709771610268, 43.158346163804168], [77.0588491320607, 43.158321791077647], [77.0589711033633, 43.158272327944573], [77.0600592202136, 43.157366445771231], [77.060131200131792, 43.157282389428453], [77.060174301137565, 43.157203587120932], [77.060172571939972, 43.157031865630053], [77.060150378670272, 43.156946389977058], [77.060102476589364, 43.156854014404587], [77.0600152410429, 43.156764385087108], [77.059925611310788, 43.156704099117292], [77.059879332416642, 43.156679042928992], [77.059749016725149, 43.156621324619543], [77.0596573219491, 43.156797115723577], [77.059811767508137, 43.156870376150437], [77.059900238581235, 43.156962884230254], [77.059935998112536, 43.157068234410843], [77.059927644336526, 43.157183176579039], [77.059870748655541, 43.157250384747172], [77.058887782188464, 43.1581172618942], [77.058773567221436, 43.158171756013488], [77.058698725197488, 43.15818462337149], [77.058561280300253, 43.158185143203767], [77.058460797100835, 43.158165819548493], [77.05834587147119, 43.158119422012469], [77.058273220752426, 43.1580655051896], [77.058199970575274, 43.157961727998547], [77.05818551918189, 43.157873632950754], [77.058198606741243, 43.157785865991229], [77.058253985101061, 43.157698140000619], [77.059217055438026, 43.156839211638783], [77.0593090488761, 43.156799773347963], [77.059417547443843, 43.156774895978117], [77.0594960970992, 43.15677183400976], [77.059603688960721, 43.156782148249022], [77.0596484634664, 43.156793886036972], [77.059729101527608, 43.15662152797421], [77.0596153352079, 43.156598440822187], [77.05953307175966, 43.156589626975389], [77.059508191365566, 43.1564553733301], [77.059248736884143, 43.1564842073164]
            ])
        },
        {
            name: "Здание Государственного музея искусств имени А. Кастеева Республики Казахстан",
            polygon: invertCoords([
                [76.91980285407648, 43.236174990031493], [76.9199543595442, 43.235118659981808], [76.919206570513964, 43.235063180237319], [76.919059114427029, 43.236119509538533], [76.91980285407648, 43.236174990031493]
            ])
        },
        {
            name: "Пансион Верненской мужской гимназии, ныне – здание Центральной городской детской библиотеки имени С. Бегалина",
            polygon: invertCoords([
                [76.955045707762537, 43.25610285323166], [76.955072577126387, 43.255900885568543], [76.955051150874425, 43.25589954108333], [76.955058519744284, 43.255859579037818], [76.955078099252987, 43.25586155400002], [76.955083622718945, 43.255825012440951], [76.955061334197765, 43.255822948177283], [76.955067842058966, 43.255784966359791], [76.955088282883764, 43.255785681093649], [76.955102148421275, 43.255684697142087], [76.954904878961514, 43.255670437808128], [76.954904024181346, 43.255685378082873], [76.954715128600768, 43.255672466280657], [76.954716968207862, 43.255656895754207], [76.954517853221148, 43.255645426232917], [76.954506686718787, 43.255727419361627], [76.954248957212982, 43.255711824157551], [76.954222080149563, 43.255902991596059], [76.954481779987489, 43.255917236357533], [76.954499330020454, 43.255793841467643], [76.954825033935819, 43.255816168781827], [76.954815708393213, 43.255884661417923], [76.954834302515792, 43.255886006671233], [76.954825959432583, 43.255949009035973], [76.95480650334089, 43.255947664001447], [76.9547916706597, 43.256087348301207], [76.955045707762537, 43.25610285323166]
            ])
        },
        {
            name: "Вознесенский кафедральный собор",
            polygon: invertCoords([
                [76.953109061635246, 43.25892142509727], [76.953297597049016, 43.258933349628123], [76.95330484665638, 43.258898607761928], [76.953377502254341, 43.258903000151349], [76.9533774982027, 43.258894090124073], [76.953420106287325, 43.2588964197743], [76.953424395297745, 43.25885042858468], [76.9534458219746, 43.258850513369758], [76.953453525109353, 43.25873036111026], [76.953434191877463, 43.258730275817129], [76.953438602325321, 43.258680594584227], [76.953397964977981, 43.2586789844641], [76.953397833727578, 43.258661164438728], [76.953320130076023, 43.258657763288909], [76.953322952684147, 43.258636522536371], [76.953137744614864, 43.258628197257067], [76.953134924863633, 43.258655918025219], [76.95306793390948, 43.2586511641199], [76.953058724940561, 43.2587103865216], [76.952774999169435, 43.258692004235051], [76.952770824215747, 43.25871864531252], [76.9527596183556, 43.258718647974383], [76.952752257239382, 43.258780209919351], [76.952770482493378, 43.258780925593022], [76.952767413203432, 43.2588017163886], [76.953045845447619, 43.258822439971581], [76.953035775046374, 43.258883012580753], [76.953113357286341, 43.258889653963088], [76.953109061635246, 43.25892142509727]
            ])
        },
        {
            name: "Здание Казахского государственного академического театра оперы и балета имени Абая",
            polygon: invertCoords([
                [76.946360819050739, 43.248192285253928], [76.9460617536281, 43.248172449054238], [76.94605265473146, 43.248208270862108], [76.945643023575826, 43.24817657322825], [76.945648427808237, 43.248136792080551], [76.945316613412388, 43.248118309675618], [76.945302243401, 43.248226942699262], [76.945632090642022, 43.248252085523553], [76.945635784249149, 43.248252084876484], [76.945633944379665, 43.248273235304993], [76.945681100777719, 43.248277277054633], [76.94572099346982, 43.248282490068959], [76.945914050854611, 43.248296766010682], [76.945900785523079, 43.248392078843331], [76.945613292950341, 43.248373319422242], [76.945615019319646, 43.248381509161057], [76.945522676686792, 43.248374595250617], [76.945438659097846, 43.248980852856349], [76.945425853681257, 43.248978515065623], [76.945413448564537, 43.249071577670442], [76.945422929709054, 43.2490739160388], [76.945418260126, 43.249101816984243], [76.945520207740458, 43.249109899311051], [76.9455124711762, 43.249171640958991], [76.945929496472658, 43.249203967743433], [76.945935631284513, 43.249139976341553], [76.946035978444286, 43.249148058493191], [76.946039046771645, 43.249118987803293], [76.946054929507483, 43.249118984963559], [76.946064259108468, 43.249036362891367], [76.946051454047947, 43.249035195176333], [76.9461275827703, 43.248419578496083], [76.946035239630817, 43.248411494993782], [76.9460383141529, 43.24840105439219], [76.945965671446331, 43.248396297327822], [76.9459793062787, 43.248301704425508], [76.946041852945285, 43.248306283285487], [76.946047261838345, 43.248281172192627], [76.946342757726285, 43.248302269083609], [76.946360819050739, 43.248192285253928]
            ])
        },
        {
            name: "Городское начальное реальное училище имени А. Колпаковского, ныне – здание Республиканского государственного предприятия Казреставрация",
            polygon: invertCoords([
                [76.957374744214519, 43.260916525428833], [76.956995690739461, 43.260895480059041], [76.956982698470384, 43.261014553960223], [76.957363721892364, 43.261033438819368], [76.957374744214519, 43.260916525428833]
            ])
        },
        {
            name: "Бюст государственного и общественного деятеля Динмухамеда Ахмедовича Кунаева",
            polygon: invertCoords([
                [76.949621630029228, 43.252825318259553], [76.949678270461618, 43.25282755635768], [76.949684403873974, 43.252769054818593], [76.9496257934263, 43.252766817137328], [76.949621630029228, 43.252825318259553]
            ])
        },
        {
            name: "Бюст дважды Героя Советского Союза С.Д. Луганского",
            polygon: invertCoords([
                [76.940547207884435, 43.258752126438857], [76.940582057716981, 43.258755451888753], [76.94058599199262, 43.258729981291353], [76.94055064976321, 43.25872728590906], [76.940547207884435, 43.258752126438857]
            ])
        },
        {
            name: "Мемориал Славы",
            polygon: invertCoords([
                [76.955143000765062, 43.258935857801262], [76.955250507318013, 43.2589436600033], [76.955260693518426, 43.258872467136179], [76.955152570946, 43.258863765099932], [76.955143000765062, 43.258935857801262]
            ])
        },
        {
            name: "Памятник Абая Құнанбайулы (Ибраһим)",
            polygon: invertCoords([
                [76.957581446566479, 43.243159750483812], [76.95759406984341, 43.243050756310353], [76.957444733357832, 43.243042427939137], [76.957442402149809, 43.243057548677569], [76.957411499819543, 43.24305413725687], [76.957406858319814, 43.243124608963683], [76.957432097582966, 43.243127931961332], [76.957432108925786, 43.243149712086527], [76.957581446566479, 43.243159750483812]
            ])
        },
        {
            name: "Памятник Мухтара Ауэзова",
            polygon: invertCoords([
                [76.917938684542321, 43.241127613580552], [76.917987064879526, 43.241129866823883], [76.917999385804052, 43.241046707120837], [76.917949035941874, 43.241043643745911], [76.917949035941874, 43.241043643745911], [76.917938684542321, 43.241127613580552]
            ])
        },
        {
            name: "Памятник Шокана Уалиханова",
            polygon: invertCoords([
                [76.952963107417233, 43.247304301619607], [76.952965194383552, 43.247290801050347], [76.95294820333406, 43.24728918510629], [76.9529456239713, 43.2473028657939], [76.952963107417233, 43.247304301619607]
            ])
        },
        {
            name: "Памятник Алиби Джангильдина",
            polygon: invertCoords([
                [76.94858223977694, 43.340324500246837], [76.948806753453454, 43.340254075655011], [76.948780224436661, 43.340206201558459], [76.9487206745506, 43.340224303421621], [76.948642323171327, 43.340086620738063], [76.948473659137548, 43.340134894087868], [76.94858223977694, 43.340324500246837]
            ])
        },
        {
            name: "Памятник Амангелды Иманова",
            polygon: invertCoords([
                [76.939522707910086, 43.265934184386147], [76.939526517223342, 43.265896833848508], [76.939451021818428, 43.265892883011041], [76.939447951027049, 43.265928613453582], [76.939522707910086, 43.265934184386147]
            ])
        },
        {
            name: "Здание дома-музея Ахмета Байтурсынулы",
            polygon: invertCoords([
                [76.927078805639653, 43.246231520126571], [76.927087668341912, 43.2461633896441], [76.927054919439129, 43.246161860057953], [76.9270589814671, 43.2461283798253], [76.9269080411144, 43.246120191610729], [76.926896101056641, 43.246223152302512], [76.927046056741148, 43.246231700547121], [76.927046056694181, 43.246229720536448], [76.927078805639653, 43.246231520126571]
            ])
        },
        {
            name: "Здание Центрального государственного музея Республики Казахстан",
            polygon: invertCoords([
                [76.950447018331715, 43.236296548440379], [76.950409485618152, 43.236325176790871], [76.950407895118261, 43.236349207305913], [76.950429815098715, 43.236370982703207], [76.950472160704066, 43.23637214351043], [76.95050181991266, 43.236354946935037], [76.950852531122152, 43.236378900207157], [76.9508681719062, 43.236397166881773], [76.950869773609654, 43.2364006765527], [76.950905718679749, 43.236402918621017], [76.95093550184734, 43.236388061922369], [76.950940168093311, 43.236360520693943], [76.9509182503203, 43.236344505434637], [76.950947929534067, 43.236078996976389], [76.950979188710534, 43.236061799921742], [76.950980776138863, 43.2360309293495], [76.950954179422723, 43.236011495110041], [76.950986939956167, 43.235756246016912], [76.951016598721253, 43.235739049306318], [76.951019787779018, 43.235711598400449], [76.9509962685629, 43.235692163485673], [76.951027426127183, 43.235431154681123], [76.951055607590689, 43.235413958287928], [76.9510587980382, 43.23538992740388], [76.951033676798261, 43.235365902819026], [76.95100241036441, 43.235364739759241], [76.950974228908592, 43.235381936139511], [76.950626724778843, 43.235360322551273], [76.950600126111709, 43.235335128185881], [76.950560982590389, 43.235336216743313], [76.9505328019778, 43.235355753031691], [76.9505312124689, 43.235382033568527], [76.950553130750521, 43.235400388921477], [76.9505172921413, 43.235657888592989], [76.950485910386, 43.235676165557052], [76.950484325537587, 43.235713966173563], [76.950464021380441, 43.235729990704513], [76.950459371691963, 43.235798662207962], [76.9504687301819, 43.235806670230851], [76.950462482596322, 43.235881102122192], [76.950440583733254, 43.235910897093618], [76.950435933054223, 43.2359772285775], [76.950450096500987, 43.23599558563204], [76.950446909038163, 43.236027626553067], [76.950473505600158, 43.236047060910487], [76.950447018331715, 43.236296548440379]
            ])
        },
        {
            name: "Здание Центрального государственного архива",
            polygon: invertCoords([
                [76.946305525937277, 43.243069017232507], [76.946345907781165, 43.242711707789169], [76.9461395727632, 43.2426992349577], [76.946135152872188, 43.242735055965547], [76.945240868636091, 43.242674372682309], [76.94524455250486, 43.242645121874418], [76.94503009257518, 43.242632108433469], [76.9449897030639, 43.242989327418378], [76.945199609123, 43.243002161713662], [76.9452204770637, 43.24281306701112], [76.946113531670889, 43.242872130663137], [76.9460909411555, 43.243055915803737], [76.946305525937277, 43.243069017232507]
            ])
        },
        {
            name: "Комплекс зданий Казахфильм им. Шакена Айманова (тонстудия, производственная, двухпавильонный блок)",
            polygon: invertCoords([
                [76.902025713699842, 43.196876494234417], [76.902027087467147, 43.196823033772922], [76.90180774775601, 43.196825058390893], [76.901632694494509, 43.196826011860828], [76.901418276248762, 43.1968259667342], [76.9013571369097, 43.196825953793137], [76.901358468287484, 43.196881034842413], [76.90109767187, 43.196882509298213], [76.901100211327034, 43.197299665634823], [76.9013849978002, 43.1972986462605], [76.9015812114657, 43.197297697614736], [76.901777301932427, 43.197297198613008], [76.901979789491364, 43.197296250590007], [76.9021682532305, 43.1972947593293], [76.902290533051143, 43.197294244304473], [76.902292099539082, 43.197057091334017], [76.902291421049469, 43.196900489018162], [76.90228995296664, 43.196879158422043], [76.902025713699842, 43.196876494234417]
            ])
        },
        {
            name: "Бывшее здание Государственной филармонии им. Жамбыла (дом Политпросвещения, Казахконцерт, ныне Казахский Государственный академический оркестр народных инструментов им. Курмангазы)",
            polygon: invertCoords([
                [76.94045, 43.25726], [76.94047, 43.25711], [76.94062, 43.25712], [76.94059, 43.25731], [76.94067, 43.25731], [76.94067, 43.25732], [76.94076, 43.25732], [76.94083, 43.25679], [76.94073, 43.25678], [76.94073, 43.25678], [76.94066, 43.25678], [76.94064, 43.25697], [76.94049, 43.25696], [76.9405, 43.25688], [76.94042, 43.25687], [76.94042, 43.25682], [76.9403, 43.25681], [76.9403, 43.25686], [76.94022, 43.25686], [76.94018, 43.25718], [76.94019, 43.25718], [76.94018, 43.25724], [76.94045, 43.25726]
            ])
        },
        {
            name: "Жилой дом (бывший дом купца Филиппова)",
            polygon: invertCoords([
                [76.96222, 43.26498], [76.96241, 43.265], [76.96244, 43.26482], [76.96225, 43.2648], [76.96222, 43.26498]
            ])
        }
    ];

    // Функция для создания полигона больше не нужна, она удалена

    // Добавляем ПОЛИГОНЫ на карту
    monuments.forEach(obj => {
        // Используем точный полигон из данных
        const polygon = L.polygon(obj.polygon, { 
            color: '#ff0000', // Изменен цвет, чтобы выделить точный полигон
            fillColor: '#ff0000', 
            fillOpacity: 0.5,
            weight: 3
        }).addTo(map);
        
        // Тултип (всплывашка)
        polygon.bindTooltip(obj.name, { sticky: true });

        // Клик - открывает 3D
        polygon.on('click', () => {
            modelTitle.innerText = obj.name;
            openModal();
            // Используем одну модель-заглушку, так как у вас пока нет реальных файлов
            loadPLY("models/object1.ply"); // Важно: замените на путь к реальным .ply файлам, если они есть
        });
    });

    // ----- Three.js 3D Viewer (без изменений) -----
    let renderer, scene, camera, controls;
    let currentMesh = null;
    let requestID;

    btnClose.onclick = () => { closeModal(); };

    function openModal() {
        modal.style.display = "flex";
        if (!renderer) initThree();
        animate();
    }

    function closeModal() {
        modal.style.display = "none";
        if (requestID) cancelAnimationFrame(requestID);
        
        if (currentMesh) {
            scene.remove(currentMesh);
            if(currentMesh.geometry) currentMesh.geometry.dispose();
            if(currentMesh.material) currentMesh.material.dispose();
            currentMesh = null;
        }
    }

    function initThree() {
        if (renderer) return;

        const width = viewer.clientWidth;
        const height = viewer.clientHeight;

        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(width, height);
        renderer.setClearColor(0xf0f0f0, 1);
        viewer.appendChild(renderer.domElement);

        scene = new THREE.Scene();

        camera = new THREE.PerspectiveCamera(60, width / height, 0.01, 1000);
        camera.position.set(2, 2, 2);

        controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;

        const ambient = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambient);
        const directional = new THREE.DirectionalLight(0xffffff, 0.8);
        directional.position.set(1, 2, 3);
        scene.add(directional);

        window.addEventListener('resize', onWindowResize);
    }

    function loadPLY(path) {
        if (!renderer) initThree();
        console.log("Загрузка модели:", path);

        const loader = new PLYLoader();
        loader.load(path, (geometry) => {
            geometry.computeVertexNormals();
            const material = new THREE.MeshStandardMaterial({ color: 0xcccccc, metalness: 0.1, roughness: 0.8 });
            const mesh = new THREE.Mesh(geometry, material);

            geometry.computeBoundingBox();
            const bbox = geometry.boundingBox;
            const size = new THREE.Vector3();
            bbox.getSize(size);
            const maxDim = Math.max(size.x, size.y, size.z);
            const scale = 1.5 / maxDim;
            mesh.scale.setScalar(scale);

            geometry.computeBoundingBox(); 
            const center = new THREE.Vector3();
            bbox.getCenter(center);
            mesh.position.sub(center.multiplyScalar(scale));
            
            mesh.rotation.x = -Math.PI / 2;

            if (currentMesh) {
                scene.remove(currentMesh);
                if(currentMesh.geometry) currentMesh.geometry.dispose();
                if(currentMesh.material) currentMesh.material.dispose();
                currentMesh = null;
            }

            currentMesh = mesh;
            scene.add(mesh);
        }, undefined, (err) => {
            console.error('Ошибка загрузки PLY:', err);
            alert("Не удалось загрузить модель: " + path);
        });

        setTimeout(onWindowResize, 100);
    }

    function animate() {
        if (modal.style.display === "none") return;
        requestID = requestAnimationFrame(animate);
        if (controls) controls.update();
        if (renderer && scene && camera) renderer.render(scene, camera);
    }

    function onWindowResize() {
        if (!renderer || !viewer) return;
        const w = viewer.clientWidth;
        const h = viewer.clientHeight;
        renderer.setSize(w, h);
        camera.aspect = w / h;
        camera.updateProjectionMatrix();
    }
</script>
</body>
</html>
